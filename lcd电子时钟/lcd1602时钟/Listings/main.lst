C51 COMPILER V9.60.7.0   MAIN                                                              04/14/2023 18:39:05 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: D:\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE INCDIR(.\users\inc) DEBUG OBJECTEXTEND P
                    -RINT(.\Listings\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          #include <reg52.h>
   2          #include "common.h"
   3          
   4          Environment gEnvironment;
   5          uchar gDispMode = eDisplayMode_dateTime;
   6          bit gSettingTime = 0;
   7          bit gSettingDate = 0;
   8          uchar gLcd1602CurSettingRow = 0;
   9          uchar gLcd1602CurSettingCol = 0;
  10          uchar gLedRunTicket = 0;
  11          uchar gLcd1602SettingTicket = 0;
  12          uchar gSettingMode = eSetting_null;
  13          
  14          void init();
  15          void run();
  16          void led_run();
  17          void timer0_init();
  18          void key1_action();
  19          void key2_action();
  20          void key3_action();
  21          void check_setting_mode();
  22          
  23          void main()
  24          {
  25   1          init();
  26   1          while(1)
  27   1          {
  28   2              while(!TF0);
  29   2              run();
  30   2          }
  31   1      }
  32          
  33          void init()
  34          {
  35   1          gEnvironment.year = 23;
  36   1          gEnvironment.mon = 4;
  37   1          gEnvironment.day = 10;
  38   1          gEnvironment.hour = 22;
  39   1          gEnvironment.min = 40;
  40   1          gEnvironment.sec = 50;
  41   1          gEnvironment.temperature[0] = 25,
  42   1          gEnvironment.temperature[1] = 0,
  43   1          gEnvironment.humidity[0] = 65,
  44   1          gEnvironment.humidity[1] = 0,
  45   1      
  46   1          timer0_init();
  47   1          ds1302_init();
  48   1          lcd1602_init();
  49   1      
  50   1          key_register(0, key1_action);
  51   1          key_register(1, key2_action);
  52   1          key_register(2, key3_action);
  53   1      }
  54          
C51 COMPILER V9.60.7.0   MAIN                                                              04/14/2023 18:39:05 PAGE 2   

  55          void led_run()
  56          {
  57   1          gLedRunTicket++;
  58   1          if (gLedRunTicket == 100) //500ms
  59   1          {
  60   2              gLedRunTicket = 0;
  61   2             // LED_RUN = ~LED_RUN;
  62   2          }
  63   1      }
  64          
  65          void run()
  66          {
  67   1          key_run();
  68   1          led_run();
  69   1          check_setting_mode();
  70   1      
  71   1          if (gSettingMode == eSetting_null)
  72   1          {
  73   2              gLcd1602SettingTicket = 0;
  74   2              ds1302_read_time(&gEnvironment);
  75   2              dht11_read_dat(&gEnvironment);
  76   2              lcd1602_display(gDispMode, gEnvironment);
  77   2          }
  78   1          else
  79   1          {
  80   2              gLcd1602SettingTicket++;
  81   2              if (gLcd1602SettingTicket == 100)
  82   2              {
  83   3                  gLcd1602SettingTicket = 0;
  84   3                  lcd1602_display_setting(gEnvironment, gSettingMode);
  85   3              }
  86   2              else
  87   2              {
  88   3                  lcd1602_display(gDispMode, gEnvironment);
  89   3              }
  90   2          }
  91   1      }
  92          
  93          void timer0_init()
  94          {
  95   1          TMOD = 0x01;
  96   1          TH0 = (65536 - 5000) / 256;
  97   1          TL0 = (65536 - 5000) % 256;
  98   1          TF0 = 0;
  99   1          TR0 = 1;
 100   1          ET0 = 1;
 101   1          EA = 1;
 102   1      }
 103          
 104          void timer0() interrupt 1
 105          {
 106   1          TH0 = (65536 - 5000) / 256;
 107   1          TL0 = (65536 - 5000) % 256;
 108   1      }
 109          
 110          void key1_action()
 111          {
 112   1          if (gDispMode != eDisplayMode_dateTime) 
 113   1              return;
 114   1          
 115   1          gLcd1602CurSettingCol++;
 116   1          if (gLcd1602CurSettingCol > 3)
C51 COMPILER V9.60.7.0   MAIN                                                              04/14/2023 18:39:05 PAGE 3   

 117   1          {
 118   2              gLcd1602CurSettingCol = 1;
 119   2              gLcd1602CurSettingRow++;
 120   2      
 121   2              if (gLcd1602CurSettingRow > 1)
 122   2                  gLcd1602CurSettingRow = 0;
 123   2          }
 124   1      }
 125          
 126          void key2_action()
 127          {
 128   1          LED_RUN = ~LED_RUN;
 129   1          switch (gLcd1602CurSettingCol)
 130   1          {
 131   2              case 1:
 132   2              {   
 133   3                  if (gLcd1602CurSettingRow == 0)    
 134   3                  {
 135   4                      gEnvironment.year++;
 136   4                      if (gEnvironment.year > 99) gEnvironment.year = 0;
 137   4                  }
 138   3                  else if (gLcd1602CurSettingRow == 1)
 139   3                  {
 140   4                      gEnvironment.hour++;
 141   4                      if (gEnvironment.hour > 23) gEnvironment.hour = 0;
 142   4                  }
 143   3      
 144   3                  break;
 145   3              }
 146   2              case 2:
 147   2              {  
 148   3                  if (gLcd1602CurSettingRow == 0)    
 149   3                  {
 150   4                      gEnvironment.mon++;
 151   4                      if (gEnvironment.mon > 12) gEnvironment.mon = 1;
 152   4                  }
 153   3                  else if (gLcd1602CurSettingRow == 1)
 154   3                  {
 155   4                      gEnvironment.min++;
 156   4                      if (gEnvironment.min > 59) gEnvironment.min = 0;
 157   4                  }
 158   3      
 159   3                  break;
 160   3              }
 161   2              case 3:
 162   2              {
 163   3                  if (gLcd1602CurSettingRow == 0)    
 164   3                  {
 165   4                      gEnvironment.day++;
 166   4                      if (gEnvironment.day > 31) gEnvironment.day = 1;
 167   4                  }
 168   3                  else if (gLcd1602CurSettingRow == 1)
 169   3                  {
 170   4                      gEnvironment.sec++;
 171   4                      if (gEnvironment.sec > 59) gEnvironment.sec = 0;
 172   4                  }
 173   3      
 174   3                  break;
 175   3              }      
 176   2          }
 177   1      }
 178          
C51 COMPILER V9.60.7.0   MAIN                                                              04/14/2023 18:39:05 PAGE 4   

 179          void key3_action()
 180          {
 181   1          gDispMode++;
 182   1          if (gDispMode >= eDisplayMode_max) 
 183   1              gDispMode = eDisplayMode_dateTime;
 184   1      
 185   1          if (gDispMode == eDisplayMode_tpHumi)
 186   1          {
 187   2              if (gSettingTime)
 188   2              {
 189   3                  ds1302_set_time(eDs1302_Set_hms, &gEnvironment);
 190   3                  gSettingTime = 0;
 191   3              }
 192   2      
 193   2              if (gSettingDate)
 194   2              {
 195   3                  ds1302_set_time(eDs1302_Set_ymd, &gEnvironment);
 196   3                  gSettingDate = 0;
 197   3              }
 198   2          }
 199   1      
 200   1          gLcd1602CurSettingRow = 0;
 201   1          gLcd1602CurSettingCol = 0;
 202   1      }
 203          
 204          void check_setting_mode()
 205          {
 206   1          if (gLcd1602CurSettingRow == 0) 
 207   1          {
 208   2              if (gLcd1602CurSettingCol == 1)
 209   2              {
 210   3                  gSettingMode = eSetting_year;
 211   3                  return;
 212   3              }
 213   2      
 214   2              if (gLcd1602CurSettingCol == 2)
 215   2              {
 216   3                  gSettingMode = eSetting_mon;
 217   3                  return;
 218   3              }
 219   2      
 220   2              if (gLcd1602CurSettingCol == 3)
 221   2              {
 222   3                  gSettingMode = eSetting_day;
 223   3                  return;
 224   3              }
 225   2          }
 226   1      
 227   1          if (gLcd1602CurSettingRow == 1) 
 228   1          {
 229   2              if (gLcd1602CurSettingCol == 1)
 230   2              {
 231   3                  gSettingMode = eSetting_hour;
 232   3                  return;
 233   3              }
 234   2      
 235   2              if (gLcd1602CurSettingCol == 2)
 236   2              {
 237   3                  gSettingMode = eSetting_min;
 238   3                  return;
 239   3              }
 240   2      
C51 COMPILER V9.60.7.0   MAIN                                                              04/14/2023 18:39:05 PAGE 5   

 241   2              if (gLcd1602CurSettingCol == 3)
 242   2              {
 243   3                  gSettingMode = eSetting_sec;
 244   3                  return;
 245   3              }
 246   2          } 
 247   1      
 248   1          gSettingMode = eSetting_null;
 249   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    483    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     16    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
